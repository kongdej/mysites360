import{c as z,b as H,d as R,O as A,f as G,i as E,u as J,j as K,r as n,k as W,g as X,_ as Y,n as d,A as h,s as o,q as t,v as D,x as S,y as c,H as Z,D as T,B as w,p as x,C as f,L as ee,az as te,z as i,M as oe,N as le}from"./index.63e8c0ce.js";import{Q as ae}from"./QSelect.d4181afb.js";import{Q as se}from"./QSpace.72b6541e.js";import{Q as ne}from"./QItemLabel.b4b1ab90.js";import{Q as re}from"./QHeader.d034929d.js";import{Q as ie}from"./QUploader.6c980c1c.js";import{Q as ue,a as _}from"./QTable.8c59de19.js";import{Q as y}from"./QTd.ada6f118.js";import{Q as I}from"./QImg.e0796625.js";import{Q as de,a as pe}from"./QLayout.1d8af999.js";import{u as ce}from"./use-quasar.9121bb9a.js";import{g as me,d as fe}from"./api.f5a83c6d.js";import{a as ge,l as ve}from"./index.ee820e5d.js";import"./format.7d43e501.js";import"./position-engine.328e85fe.js";import"./QScrollObserver.8aef43d3.js";import"./use-ratio.9183a368.js";import"./index.58290dd4.js";var M=z({name:"QTr",props:{props:Object,noHover:Boolean},setup(e,{slots:p}){const b=H(()=>"q-tr"+(e.props===void 0||e.props.header===!0?"":" "+e.props.__trClass)+(e.noHover===!0?" q-tr--no-hover":""));return()=>R("tr",{class:b.value},A(p.default))}}),he=G({name:"UploadPage",setup(){const e=E("store"),p=J(),b=K(),g=n(p.params.site),k=n(e.state.token!=""),P=X();P.appContext.config.globalProperties.$imgUrl;const l=P.appContext.config.globalProperties.$baseUrl,$=P.appContext.config.globalProperties.$photoUrl,Q=ce(),r=n([]),V=n([{name:"Photo 360",required:!0,align:"center",field:"image",style:"width:350px;"},{name:"Info",required:!0,align:"center",field:"photo_id",style:"width:150px;"},{name:"Map Name",required:!0,align:"left",sortable:!0,filter:!0,field:"map_name"},{name:"Point No",required:!0,align:"center",field:"point_no",style:"width:50px;"},{name:"Point Name",required:!0,align:"left",field:"point_name"}]),u=n([]),N=n("");n([]);const m=n(),j=n([]),v=n(),C=n([]),q=n();return W(async()=>{if(!k.value)b.push("/");else{let s=await me(g.value,e.state.token);console.log("results",e.state.token),r.value=s.map(a=>({photo_id:a.photo_id,exif:a.exif,user:a.user,image:`${$}/${a.site_id}/${a.photo_id}/low.jpg`})),console.log("photos",r.value)}}),{uploaderPointRef:q,handlePointUpload:s=>{console.log(s),q.value.pointFile=s.files[0],console.log("handle point upload",q.value.pointFile),s.xhr.onload=function(){if(s.xhr.status===200){const a=JSON.parse(s.xhr.responseText);console.log("Response:",a),Q.notify({position:"top",message:a.results.msg,color:a.results.status?"purple":"red"})}}},factoryFn:async s=>new Promise(a=>{a({url:`${l}uploadbulk`,methods:"POST",headers:[{name:"Authorization",value:e.state.token}],formFields:[{name:"site_id",value:g.value},{name:"postby",value:e.state.user.username}]})}),selectedPoint:v,listPoints:C,updatePoints:()=>{console.log("select map",m.value),C.value=m.value.points.map(s=>({label:s.name,value:s.id})),console.log("points",C.value)},listMaps:j,selectedMap:m,filterMethod:(s,a,U)=>{if(!a.length)return s;const B=a[0].toLowerCase();return s.filter(F=>U.some(L=>{const O=F[L.name];return String(O).toLowerCase().includes(B)}))},filter:N,site:g,authorized:k,photos:r,tableColumns:V,dAgo:ge,formattDate:s=>ve(s),baseUrl:l,selected:u,handleMove:async()=>{console.log("selected",u.value),console.log("move",m.value,v.value),movePhotos(u.value,g.value,m.value,v.value,e.state),u.value.map(s=>{const a=r.value.findIndex(U=>U.photo_id==s);console.log("index",a),a!=-1&&(r.value[a].point_id=v.value.value,r.value[a].point_name=v.value.label,r.value[a].map_id=m.value.value,r.value[a].map_name=m.value.label)}),Q.notify({position:"top",message:"move done.",color:"purple"}),u.value=[]},handleDelete:()=>{Q.dialog({title:"Confirm",message:"Delete photos?",cancel:!0,persistent:!0}).onOk(async()=>{console.log("delete",u.value),await fe(u.value,e.state.token),r.value=r.value.filter(s=>!u.value.includes(s.photo_id)),Q.notify({position:"top",message:"Delete done.",color:"purple"}),u.value=[]}).onCancel(()=>{console.log(">>>> Cancel")})}}}});const _e=e=>(oe("data-v-3fc21c32"),e=e(),le(),e),ye={class:"flex flex-center q-pa-md-xl q-pa-none"},we={key:0,class:"full-width"},be={class:"flex q-my-md"},Pe={key:0},Qe={key:0},xe=_e(()=>w("br",null,null,-1)),ke={key:0};function $e(e,p,b,g,k,P){return d(),h(de,{view:"hHh lpr fff"},{default:o(()=>[t(re,{elevated:"",class:"bg-grey-9 text-grey-1"},{default:o(()=>[t(ne,null,{default:o(()=>[t(ae,null,{default:o(()=>[t(D,null,{default:o(()=>[t(S,{name:"upload",size:"sm"})]),_:1}),c(" Upload Photos ")]),_:1}),t(se),t(Z,{dark:"",vertical:""}),t(T,{class:"",rounded:"",flat:"",color:"grey-1",to:"/"+e.site+"/geomap","icon-right":"close",label:"Close"},null,8,["to"])]),_:1})]),_:1}),t(pe,{calss:"bg-grey-8"},{default:o(()=>[w("div",ye,[t(ie,{ref:"uploaderPointRef",extensions:"['jpg', 'jpeg']",factory:e.factoryFn,onUploaded:e.handlePointUpload,"auto-upload":"false",multiple:"",label:"Upload Photos",class:"q-mb-md full-width bg-grey-12",style:{"max-width":"300px"}},null,8,["factory","onUploaded"]),e.selected.length>0?(d(),x("div",we,[w("div",be,[t(T,{color:"red",icon:"delete",label:"Delete",onClick:e.handleDelete},null,8,["onClick"])])])):f("",!0),t(ue,{title:"Photos",rows:e.photos,columns:e.tableColumns,"row-key":"id","rows-per-page-options":[100,150,200],pagination:!0,"selected-rows-label":{singular:"item selected",plural:"items selected"},class:"full-width",filter:e.filter,"visible-columns":["point_no"],"wrap-cells":"",grid:e.$q.screen.xs,dense:e.$q.screen.lt.md},{"top-right":o(()=>[t(ee,{rounded:"",outlined:"",dense:"",debounce:"300",modelValue:e.filter,"onUpdate:modelValue":p[0]||(p[0]=l=>e.filter=l),placeholder:"Search"},{append:o(()=>[t(S,{name:"search"})]),_:1},8,["modelValue"])]),header:o(l=>[t(M,{class:"custom-header"},{default:o(()=>[t(_),t(_,null,{default:o(()=>[c("Photo")]),_:1}),t(_,null,{default:o(()=>[c("Date")]),_:1}),t(_,null,{default:o(()=>[c("Info")]),_:1}),t(_,null,{default:o(()=>[c("Poster")]),_:1})]),_:1})]),body:o(l=>[(d(),h(M,{props:l,key:`m_${l.row.photo_id}`},{default:o(()=>[t(y,{style:{width:"50px","vertical-align":"top"}},{default:o(()=>[t(te,{modelValue:e.selected,"onUpdate:modelValue":p[1]||(p[1]=$=>e.selected=$),val:l.row.photo_id},null,8,["modelValue","val"])]),_:2},1024),t(y,null,{default:o(()=>[t(I,{fit:"cover",style:{"max-height":"200px"},src:l.row.image,"spinner-color":"white",class:"table-image"},null,8,["src"]),e.$q.screen.lt.lg?(d(),x("div",Pe,[e.$q.screen.xs?(d(),x("div",Qe,i(e.formattDate(l.row.point_id)),1)):f("",!0),w("div",null,i(l.row.map_name)+" : "+i(l.row.point_name),1)])):f("",!0)]),_:2},1024),e.$q.screen.gt.xs?(d(),h(y,{key:0,style:{width:"200px","text-align":"center","vertical-align":"top"}},{default:o(()=>[c(i(e.formattDate(l.row.exif.DateTimeOriginal)),1)]),_:2},1024)):f("",!0),e.$q.screen.gt.xs?(d(),h(y,{key:1,style:{width:"200px","text-align":"center","vertical-align":"top"}},{default:o(()=>[c(i(l.row.exif.Make)+" , "+i(l.row.exif.Model),1),xe,c(" "+i(l.row.exif.GPSLatitude)+" , "+i(l.row.exif.GPSLongitude),1)]),_:2},1024)):f("",!0),e.$q.screen.gt.xs?(d(),h(y,{key:2,style:{width:"180px","text-align":"center","vertical-align":"top"}},{default:o(()=>[t(D,null,{default:o(()=>[t(I,{src:`${e.baseUrl}avatars/${l.row.user.empn}.jpg`},null,8,["src"])]),_:2},1024),w("div",null,i(l.row.user.name),1),e.$q.screen.gt.md?(d(),x("div",ke,i(l.row.user.dept),1)):f("",!0)]),_:2},1024)):f("",!0)]),_:2},1032,["props"]))]),_:1},8,["rows","columns","filter","grid","dense"])])]),_:1})]),_:1})}var Ye=Y(he,[["render",$e],["__scopeId","data-v-3fc21c32"]]);export{Ye as default};
